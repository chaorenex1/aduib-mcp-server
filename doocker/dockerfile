# dockerfile
FROM python:3.12-slim

# 基本设置
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app
ENV TZ=Asia/Shanghai
ENV DOCKER_ENV=true
ENV APP_HOST=10.0.0.96
WORKDIR /app

# 安装系统依赖（用于编译扩展，如 psycopg2）
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    gcc \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# 先复制依赖描述文件以利用缓存
COPY pyproject.toml uv.lock* ./

# 安装 uv 包管理器并使用 uv 安装依赖（只安装非 dev 依赖）
RUN pip install --no-cache-dir uv \
    && uv sync --frozen --no-dev

# 复制项目源码
COPY . .

# 确保日志目录存在
RUN mkdir -p /app/logs

# 暴露端口
EXPOSE 5002

# 启动命令：假设 FastAPI app 在 aduib_mcp_server.app:app
CMD ["uv", "run", "uvicorn", "aduib_mcp_server.app:app", "--host", "0.0.0.0", "--port", "5002"]
